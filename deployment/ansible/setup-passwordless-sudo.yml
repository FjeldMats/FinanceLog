- name: Setup passwordless sudo for deployment user
  hosts: all
  become: true
  
  tasks:
    - name: Ensure sudoers.d directory exists
      file:
        path: /etc/sudoers.d
        state: directory
        mode: '0750'
    
    - name: Add passwordless sudo for user
      copy:
        content: |
          # Allow {{ ansible_user }} to run all commands without password
          {{ ansible_user }} ALL=(ALL) NOPASSWD: ALL
        dest: "/etc/sudoers.d/{{ ansible_user }}-nopasswd"
        mode: '0440'
        validate: 'visudo -cf %s'
      
    - name: Verify sudoers file syntax
      command: visudo -c
      changed_when: false

